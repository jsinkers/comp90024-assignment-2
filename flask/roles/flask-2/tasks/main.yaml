---
# Run flask via gunicorn
- name: kill gunicorn if already running
  command: 'pkill gunicorn'
  register: pkill_result
  ignore_errors: True
- debug: var=pkill_result
- name: Copy flask files to VM
  ansible.builtin.copy:
    src: ../../../../flask/
    dest: flask 
- name: Copy frontend files to VM
  ansible.builtin.copy:
    src: ../../../frontend/public/
    dest: frontend/public
- name: install gunicorn
  become: yes
  ansible.builtin.apt:
    name: ['gunicorn']
    update_cache: yes

- name: install dependencies
  ansible.builtin.pip:
    chdir: flask
    requirements: requirements.txt
- name: run gunicorn
  community.general.gunicorn:
    app: 'app:app'
    chdir: /home/ubuntu/flask
    conf: /home/ubuntu/flask/gunicorn.conf.py
    pid: /home/ubuntu/flask/pidfile
